class PaypalAccountsController < ApplicationController
  before_filter do |controller|
    controller.ensure_logged_in t("layouts.notifications.you_must_log_in_to_view_your_settings")
  end

  before_filter :ensure_paypal_enabled

  PaypalAccountForm = FormUtils.define_form("PaypalAccountForm")

  DataTypePermissions = PaypalService::DataTypes::Permissions

  def show
    return redirect_to action: :new unless PaypalHelper.account_prepared_for_user?(@current_user.id, @current_community.id)

    m_account = accounts_api.get(
      community_id: @current_community.id,
      person_id: @current_user.id
    ).maybe

    @selected_left_navi_link = "payments"

    community_ready_for_payments = PaypalHelper.community_ready_for_payments?(@current_community)
    unless community_ready_for_payments
      flash.now[:warning] = t("paypal_accounts.new.admin_account_not_connected",
                            contact_admin_link: view_context.link_to(
                              t("paypal_accounts.new.contact_admin_link_text"),
                                new_user_feedback_path)).html_safe
    end

    render(locals: {
      community_ready_for_payments: community_ready_for_payments,
      left_hand_navigation_links: settings_links_for(@current_user, @current_community),
      paypal_account_email: m_account[:email].or_else(""),
      paypal_account_state: m_account[:state].or_else(:not_connected),
      change_url: ask_order_permission_person_paypal_account_path(@current_user)
    })
  end

  def new
    return redirect_to action: :show if PaypalHelper.account_prepared_for_user?(@current_user.id, @current_community.id)

    m_account = accounts_api.get(
      community_id: @current_community.id,
      person_id: @current_user.id
    ).maybe

    @selected_left_navi_link = "payments"

    community_ready_for_payments = PaypalHelper.community_ready_for_payments?(@current_community)
    unless community_ready_for_payments
      flash.now[:warning] = t("paypal_accounts.new.admin_account_not_connected",
                            contact_admin_link: view_context.link_to(
                              t("paypal_accounts.new.contact_admin_link_text"),
                                new_user_feedback_path)).html_safe
    end

    community_currency = @current_community.default_currency
    payment_settings = payment_settings_api.get_active(community_id: @current_community.id).maybe.get
    community_country_code = LocalizationUtils.valid_country_code(@current_community.country)

    render(locals: {
      community_ready_for_payments: community_ready_for_payments,
      left_hand_navigation_links: settings_links_for(@current_user, @current_community),
      order_permission_action: ask_order_permission_person_paypal_account_path(@current_user),
      billing_agreement_action: ask_billing_agreement_person_paypal_account_path(@current_user),
      paypal_account_form: PaypalAccountForm.new,
      paypal_account_state: m_account[:order_permission_state].or_else(""),
      paypal_account_email: m_account[:email].or_else(""),
      change_url: ask_order_permission_person_paypal_account_path(@current_user),
      commission_from_seller: t("paypal_accounts.commission", commission: payment_settings[:commission_from_seller]),
      minimum_commission: Money.new(payment_settings[:minimum_transaction_fee_cents], community_currency),
      commission_type: payment_settings[:commission_type],
      currency: community_currency,
      create_url: "https://www.paypal.com/#{community_country_code}/signup",
      upgrade_url: "https://www.paypal.com/#{community_country_code}/upgrade"
    })
  end

  def ask_order_permission
    return redirect_to action: :new unless PaypalHelper.community_ready_for_payments?(@current_community)

    # Select paypal account connect flow
    flow = use_new_connect_flow?(@current_community) ? :new : :old
    callback_url = flow == :new ? paypal_connect_person_paypal_account_url : permissions_verified_person_paypal_account_url

    community_country_code = LocalizationUtils.valid_country_code(@current_community.country)
    response = accounts_api.request(
      body: PaypalService::API::DataTypes.create_create_account_request(
      {
        community_id: @current_community.id,
        person_id: @current_user.id,
        callback_url: callback_url,
        country: community_country_code
      }),
      flow: flow)

    permissions_url = response.data[:redirect_url]

    if permissions_url.blank?
      flash[:error] = t("paypal_accounts.new.could_not_fetch_redirect_url")
      return redirect_to action: :new
    else
      return redirect_to permissions_url
    end
  end

  def ask_billing_agreement
    return redirect_to action: :new unless PaypalHelper.community_ready_for_payments?(@current_community)

    account_response = accounts_api.get(
      community_id: @current_community.id,
      person_id: @current_user.id
    )
    m_account = account_response.maybe

    case m_account[:order_permission_state]
    when Some(:verified)

      response = accounts_api.billing_agreement_request(
        community_id: @current_community.id,
        person_id: @current_user.id,
        body: PaypalService::API::DataTypes.create_create_billing_agreement_request(
          {
            description: t("paypal_accounts.new.billing_agreement_description"),
            success_url:  billing_agreement_success_person_paypal_account_url,
            cancel_url:   billing_agreement_cancel_person_paypal_account_url
          }
        ))

      billing_agreement_url = response.data[:redirect_url]

      if billing_agreement_url.blank?
        flash[:error] = t("paypal_accounts.new.could_not_fetch_redirect_url")
        return redirect_to action: :new
      else
        return redirect_to billing_agreement_url
      end

    else
      redirect_to action: ask_order_permission
    end
  end

  def permissions_verified

    unless params[:verification_code].present?
      return flash_error_and_redirect_to_settings(error_msg: t("paypal_accounts.new.permissions_not_granted"))
    end

    response = accounts_api.create(
      community_id: @current_community.id,
      person_id: @current_user.id,
      order_permission_request_token: params[:request_token],
      body: PaypalService::API::DataTypes.create_account_permission_verification_request(
        {
          order_permission_verification_code: params[:verification_code]
        }
      ),
      flow: :old)

    if response[:success]
      redirect_to new_paypal_account_settings_payment_path(@current_user.username)
    else
      flash_error_and_redirect_to_settings(error_response: response) unless response[:success]
    end
  end

  def paypal_connect
    onboarding_params = params.slice(
      :merchantId,
      :merchantIdInPayPal,
      :permissionsGranted,
      :accountStatus,
      :consentStatus,
      :productIntentID,
      :isEmailConfirmed,
      :returnMessage)

    response = accounts_api.create(
      community_id: @current_community.id,
      person_id: @current_user.id,
      order_permission_request_token: nil,
      body: PaypalService::API::DataTypes.create_account_permission_verification_request(
        {
          onboarding_params: onboarding_params,
        }
      ),
      flow: :new)

    if response[:success]
      redirect_to new_paypal_account_settings_payment_path(@current_user.username)
    else
      flash_error_and_redirect_to_settings(error_response: response) unless response[:success]
    end
  end

  def billing_agreement_success
    response = accounts_api.billing_agreement_create(
      community_id: @current_community.id,
      person_id: @current_user.id,
      billing_agreement_request_token: params[:token]
    )

    if response[:success]
      redirect_to show_paypal_account_settings_payment_path(@current_user.username)
    else
      case response.error_msg
      when :billing_agreement_not_accepted
        flash_error_and_redirect_to_settings(error_msg: t("paypal_accounts.new.billing_agreement_not_accepted"))
      when :wrong_account
        flash_error_and_redirect_to_settings(error_msg: t("paypal_accounts.new.billing_agreement_wrong_account"))
      else
        flash_error_and_redirect_to_settings(error_response: response)
      end
    end
  end

  def billing_agreement_cancel
    accounts_api.delete_billing_agreement(
      community_id: @current_community.id,
      person_id: @current_user.id
    )

    flash[:error] = t("paypal_accounts.new.billing_agreement_canceled")
    redirect_to new_paypal_account_settings_payment_path(@current_user.username)
  end


  private

  # Before filter
  def ensure_paypal_enabled
    unless PaypalHelper.paypal_active?(@current_community.id)
      flash[:error] = t("paypal_accounts.new.paypal_not_enabled")
      redirect_to person_settings_path(@current_user)
    end
  end

  def flash_error_and_redirect_to_settings(error_response: nil, error_msg: nil)
    error_msg =
      if (error_msg)
        error_msg
      elsif (error_response && error_response[:error_code] == "570058")
        t("paypal_accounts.new.account_not_verified")
      elsif (error_response && error_response[:error_code] == "520009")
        t("paypal_accounts.new.account_restricted")
      else
        t("paypal_accounts.new.something_went_wrong")
      end

    flash[:error] = error_msg
    redirect_to action: error_redirect_action
  end

  def error_redirect_action
    if PaypalHelper.account_prepared_for_user?(@current_user.id, @current_community.id)
      :show
    else
      :new
    end
  end

  def payment_gateway_commission(community_id)
    p_set =
      Maybe(payment_settings_api.get_active(community_id: community_id))
      .map {|res| res[:success] ? res[:data] : nil}
      .select {|set| set[:payment_gateway] == :paypal }
      .or_else(nil)

    raise ArgumentError.new("No active paypal gateway for community: #{community_id}.") if p_set.nil?

    p_set[:commission_from_seller]
  end

  # TODO Per community "Feature flag" for using new paypal account connect flow
  def use_new_connect_flow?(community)
    false
  end

  def paypal_minimum_commissions_api
    PaypalService::API::Api.minimum_commissions
  end

  def payment_settings_api
    TransactionService::API::Api.settings
  end

  def accounts_api
    PaypalService::API::Api.accounts_api
  end

end
